function MainLoop(){mouseHandler.UpdateMouseDelta(),UITick();var e=+new Date;e>=lastUpdate+msPerUpdate&&(view.clear(),keyboardState.cycleKeyState(),currentLevels&&currentLevels.Step((e-lastUpdate)/1e3),currentLevels&&currentLevels.Draw(view),DrawUI(),lastUpdate=e),requestAnimationFrame(function(){MainLoop()})}function StartMainMenu(){}function StartEditor(){gameMode=Mode.edit,currentLevels=new LevelSet([new Level(0,0,levelString)])}function EditorTick(){if(mouseHandler.isMouseLeftClicked){for(var e=0,t=editorButtons;e<t.length;e++){var n=t[e];n.isMouseWithin()&&n.onClick()}if(mouseHandler.mouseX<=editorPaneWidth)return;var i=editorButtons.find(function(e){return e instanceof EditorButtonElement&&e.isActive}),r=levelTiles[i.index],o=r.character;if("x"==o&&!mouseHandler.isMouseLeftChanged)return;var s=view.getBottomLeftGameCoordOfMouseOverCell(),a=s.x/2,l=-s.y/2;"x"==o&&(levelString=levelString.replace("x","_")),levelString=ReplaceChar(levelString,o,a,l),StartEditor()}else if(mouseHandler.isMouseRightChanged){var s=view.getBottomLeftGameCoordOfMouseOverCell(),a=s.x/2,l=-s.y/2,_="_";try{_=levelString.split("\n")[l][a]," "==_&&(_="_")}catch(e){}try{var u=levelTiles.find(function(e){return e.character==_}),h=levelTiles.indexOf(u);editorButtons[h].onClick()}catch(e){var u=levelTiles.find(function(e){return"_"==e.character}),h=levelTiles.indexOf(u);editorButtons[h].onClick()}}keyboardState.isLeftPressed()&&(view.offsetX-=1),keyboardState.isRightPressed()&&(view.offsetX+=1),keyboardState.isDownPressed()&&(view.offsetY-=1),keyboardState.isUpPressed()&&(view.offsetY+=1),keyboardState.isSpacePressed()&&(gameMode=Mode.test)}function ReplaceChar(e,t,n,i){for(;i<0;i++)e="\n"+e,view.y-=2;for(;n<0;n++)e="_"+e,e=e.replace(/\r?\n/g,"\n_"),view.x+=2;for(var r=e.split("\n");i>=r.length;r.push(""));for(var o=r[i];n>=o.length;o+="_");return o=o.substr(0,n)+t+o.substr(n+t.length),r[i]=o,r.join("\n")}function DrawEditorPane(e){var t=editorPaneWidth,n=10,i=2;if(!editorButtons.length){for(var r=levelTiles.length,o=e.height,s=Math.ceil(r/i)+3,a=(t-n)/i-n,l=Math.min(50,(o-n)/s-n),_=levelTiles.filter(function(e){return""===e.group}),u=0;u<_.length;u++){var h=_[u],d=n+(n+a)*(u%i),c=n+(n+l)*(0+Math.floor(u/i)),f=new EditorButtonElement(d,c,a,l,levelTiles.indexOf(h),h.name,0==u);editorButtons.push(f)}for(var p=Math.floor(_.length/i),v=levelTiles.filter(function(e){return""!==e.group}),m=v.map(function(e){return e.group}).distinct(),g=function(e){var i=v.filter(function(t){return t.group===e}),r=n+(n+l)*p,o=(t-n)/(i.length+2)-n,s=2*o+n,a=new MenuLabel(n,r,s,l,e);editorButtons.push(a);for(var _=0;_<i.length;_++){var u=i[_],h=n+(n+o)*(2+_),d=new EditorButtonElement(h,r,o,l,levelTiles.indexOf(u),u.name,!1);editorButtons.push(d)}p++},y=0,x=m;y<x.length;y++){var w=x[y];g(w)}var M=new EditorButton(n,o-3*(n+1.5*l),(t-n)/2-n,1.5*l,"Export",function(){prompt("Here's your level code:",levelString.replace(/\r?\n/g,"/"))});editorButtons.push(M);var L=new EditorButton((t+n)/2,o-3*(n+1.5*l),(t-n)/2-n,1.5*l,"Import",function(){var e=prompt("Please enter your level code:");e&&e.length&&(levelString=e.replace(/[\/]/g,"\n"),StartEditor())});editorButtons.push(L);var k=new EditorButton(n,o-4*(n+1.5*l),t-2*n,1.5*l,"Test Level",function(){gameMode=Mode.test});editorButtons.push(k);var T=new EditorButton(n,o-1*(n+1.5*l),t-2*n,1.5*l,"Exit to Main Menu",function(){gameMode=Mode.play,MainMenu()});editorButtons.push(T)}e.ctx.fillStyle="rgba(45,45,63,0.3)",e.ctx.fillRect(t,0,5,e.height),e.ctx.fillStyle="rgba(45,45,63,1)",e.ctx.fillRect(0,0,t,e.height);for(var S=0,b=editorButtons;S<b.length;S++){var f=b[S];f.draw(e)}}function loadLevelTiles(){fds={ball:{userData:"ball",density:1,friction:.9,restitution:0},wall:{density:0,friction:.2,restitution:.5},curve:{density:0,friction:.2,restitution:.1},bouncer:{density:0,friction:.2,userData:"bouncer"},pin:{density:0,friction:.2,restitution:.9},goal:{density:0,friction:.2,userData:"goal"},pusher:{shape:planck.Box(1,1),isSensor:!0,userData:"pusher"},breakWall:{density:0,friction:.2,restitution:.1,userData:"breakWall"},rotationLock:{density:0,friction:.2,restitution:.5,userData:"rotationLock"},timerPenalty:{density:0,friction:.2,restitution:.5,userData:"timerPenalty"}},levelTiles=[new LevelTile("x","Ball Start",function(e,t,n){view.setTranslation(t,n);var i=e.world.createDynamicBody(planck.Vec2(t,n-.5));i.setSleepingAllowed(!1),i.createFixture(planck.Circle(.45),fds.ball),e.ball=i}),new LevelTile("#","Wall",function(e,t,n){var i=e.world.createBody(planck.Vec2(t,n));i.createFixture(planck.Box(1,1),fds.wall)}),new LevelTile("g","Goal",function(e,t,n){var i=e.world.createBody(planck.Vec2(t,n));i.createFixture(planck.Box(1,1),fds.goal)}),new LevelTile("o","Bouncer",function(e,t,n){var i=e.world.createBody(planck.Vec2(t,n));i.createFixture(planck.Circle(1),fds.bouncer)}),new LevelTile(".",".",function(e,t,n){e.AddPin(t,n)},"Pin"),new LevelTile("+","+",function(e,t,n){e.AddPin(t-.5,n),e.AddPin(t+.5,n),e.AddPin(t,n+.5),e.AddPin(t,n-.5)},"Pin"),new LevelTile(":",":",function(e,t,n){e.AddPin(t,n-.5),e.AddPin(t,n+.5)},"Pin"),new LevelTile("…","..",function(e,t,n){e.AddPin(t-.5,n),e.AddPin(t+.5,n)},"Pin"),new LevelTile("◣","◣",function(e,t,n){e.AddTriangle(t,n,0)},"Ramp"),new LevelTile("◢","◢",function(e,t,n){e.AddTriangle(t,n,Math.PI/2)},"Ramp"),new LevelTile("◤","◤",function(e,t,n){e.AddTriangle(t,n,-Math.PI/2)},"Ramp"),new LevelTile("◥","◥",function(e,t,n){e.AddTriangle(t,n,Math.PI)},"Ramp"),new LevelTile("◟","◣",function(e,t,n){e.AddCurve(t,n,0)},"Curve"),new LevelTile("◞","◢",function(e,t,n){e.AddCurve(t,n,Math.PI/2)},"Curve"),new LevelTile("◜","◤",function(e,t,n){e.AddCurve(t,n,-Math.PI/2)},"Curve"),new LevelTile("◝","◥",function(e,t,n){e.AddCurve(t,n,Math.PI)},"Curve"),new LevelTile("<","<",function(e,t,n){e.AddPusher(t,n,Direction.Left)},"Pusher"),new LevelTile(">",">",function(e,t,n){e.AddPusher(t,n,Direction.Right)},"Pusher"),new LevelTile("^","^",function(e,t,n){e.AddPusher(t,n,Direction.Up)},"Pusher"),new LevelTile("v","v",function(e,t,n){e.AddPusher(t,n,Direction.Down)},"Pusher"),new LevelTile("m","Breakwall Pair Bottom",function(e,t,n){e.AddBreakWall(t-.5,n-.5,0),e.AddBreakWall(t+.5,n-.5,0)}),new LevelTile("B","Breakwall Bonus Time",function(e,t,n){e.AddBreakWall(t-.5,n-.5,5),e.AddBreakWall(t+.5,n-.5,1),e.AddBreakWall(t-.5,n+.5,1),e.AddBreakWall(t+.5,n+.5,3)}),new LevelTile("P","Breakwall Penalty Time",function(e,t,n){e.AddBreakWall(t-.5,n-.5,-2),e.AddBreakWall(t+.5,n-.5,0),e.AddBreakWall(t-.5,n+.5,0),e.AddBreakWall(t+.5,n+.5,-2)}),new LevelTile("N","Timer Penalty",function(e,t,n){var i=e.world.createBody(planck.Vec2(t,n));i.createFixture(planck.Box(1,1),fds.timerPenalty)}),new LevelTile("q","Lock Rotation",function(e,t,n){e.fullRotation=!1;var i=e.world.createBody(planck.Vec2(t,n));i.createFixture(planck.Box(1,1),fds.rotationLock)}),new LevelTile("_","ERASER",function(e,t,n){})]}function loadLevels(){levels=[],levels.push(new Level(6,30,"q\n     #########\n     #     BB#\n     # x     #\n     ###g#   #\n          ggg \n")),levels.push(new Level(1,45,"\n##############\n#            #\n#            #\n#    ####    #\n# x  #  #gggg#\n##############\n","Rotate the maze with Left and Right.")),levels.push(new Level(1,30,"\n##############\n#            #\n#            #\n# x          # ######\n##########   # #gggg#\n         #   # #    #\n         #   # #    #\n     #####   # #    #\n     #       # ###  #\n     #       # #    #\n     #       # #    #\n######   ##### #    #\n#        #     #  ###\n#        #     #    #\n#        #    #◤    #\n#    #####   #◤     #\n#    #      #◤     ◢#\n#    #######◤     ◢#\n#                ◢#\n#               ◢#\n#              ◢#\n################\n","Navigate to the end of each maze before time runs out.")),levels.push(new Level(1,30,"q\n     #########\n     #       #\n     # x     #\n     #####   #######\n     #             #\n     #             #\n######  ◥#######◤  ######\n#                       #\n#        #  g  #        #\n#  #######  g  #######  #\n#                       #\n#         ◢###◣         #\n#########################\n","Some mazes can't be completely rotated.")),levels.push(new Level(1,30,"\n#########\n#       # ############# ############\n#       # #          o# #          #\n# x #   # #     .     # #          #\n#####   # #           # #          #\n    #   # #    ###    ###   ####   #\n    #   ###    # #          # #g   #\n    #          # #     .    # #g   #\n    #    .     # #         o# #g   #\n    #         o# ############ #g   #\n    ############              ######\n","Round bumpers and pins will bounce the marble around.")),levels.push(new Level(1,30,"\n#######\n#_____#########\n# ____________#\n# _# _#_______#\n# _#NN#####_x_#\n#__#__#N#N#####\n# ____##N##g__#\n# ____#N#N#g__#\n####__#######_#\n#_____#_____N_#\n#_____#_____N_#\n#__#NN#__#__#_#\n#________N____#\n#________N____#\n###############\n","Red blocks will run out your timer faster. Don't touch them!")),levels.push(new Level(1,30,"\n##############gg#\n#______#_____#mm#\n#______#_____#mm#\n#___#__#mm#__#mm#\n#___#__#BB#__#mm#\n#___#__#__#__#mm#\n#___#__#__#__#__#\n#_x_#mm#__#__#__#\n#####__#__#_____#\n____#_____#P____#\n____#_____#PP___#\n____#############\n","Small blocks can be broken with enough speed.")),levels.push(new Level(2,60,"\n         #################\n         #################\n###########            ◝##\n###########             ##\n##       ##    #####    ##\n## x           #####    ##\n##    ##       ##       ##\n###########    ##      ◞##\n#################  #######\n##              #  #######\n##              #  ##\n##  ####### .. ##  ##\n##  ####### .. ##  ##◣\n##  #######◣  ◢##  ◥##◣\n##   #######gg###◣  ◥##◣\n##      ##########◣  ◥##◣\n##  . .   #####  ##◣  ◥###\n##     .  ◥##     ◥#◣  ◥##\n##### .  . ##      ◥#◣  ##\n #####◣    ##  ##◣  ◥#  ##\n  #####◣   ##  ###◣     ##\n   ######  ##  ####◣   ◢##\n    #####  ##  ###########\n     ####  ##mm##\n      ###      ##\n       ##      ##\n        #########\n")),levels.push(new Level(2,30,"\n################\n##◤______#_____#\n#◤_______#_◣_◢_#\n# _______#_#g#_#\n# _###_#B#_###_#\n#  _#___##_____#\n# __#___##_____#\n#  _#_x_##_____#\n#…__######B#___#\n# __#◜___##◤___#\n# __#____#◤___◢#\n#___#_#______◢##\n#◣____#_____◢###\n##◣__◞#__o_◢####\n################\n")),levels.push(new Level(2,30,"\n#################\n#◜   >  :  <   ◝#\n#    >  :  <    #\n#  ####◣ ◢##.  .#\n#    ##ggg## .  #\n###  #######    #\n#    #◜ x ◝#  . #\n#    # ### #  . #\n#    #◟   ◞#.   #\n#  ##### ###   .#\n#    #◜   ◝# . .#\n###  #  o  #  . #\n#    #◟   ◞# .  #\n#  ##### #####  #\n#     <   >     #\n#################\n")),levels.push(new Level(2,40,"\n#################\n#◜_____◝#◜_____◝#\n# #####_#_#####_#\n#◟___◝#_#_#◜___◞#\n#####_#_#_#_#####\n#◜  _◞#◟_◞#_#◜_◝#\n# #########_#_#_#\n#◟ ◝#___#BB_#_#_#\n### #_x_#BB_#_#_#\n#◜ ◞#◣_◢###_#_#_#\n#◟◝###_#◜__◞#_#_#\n#◜◞#g#_#_####_#_#\n#◟◝#g#_#◟____◞#_#\n#◜◞#_#_########_#\n#◟  ◞#◟________◞#\n#################\n")),levels.push(new Level(2,30,"\n##################\n#x   ◥◣    ◢◤    #\n###◣  ◥◣  ◢◤  .  #\n#g ◥◣  ◥◣◢◤  ◢◤  #\n#g  ◥◣  ◥◤  ◢◤  ◢#\n#◢◣  ◥◣    ◢◤  ◢◤#\n#◥◤◢◣ ◥◣  ◢◤  ◢◤ #\n#  ◥◤◢◣◥◣◢◤. ◢◤  #\n#  ◢◣◥◤◢◤◥◣. ◥◣  #\n#◢◣◥◤ ◢◤..◥◣  ◥◣ #\n#◥◤  ◢◤    ◥◣  ◥◣#\n#   ◢◤  ◢◣  ◥◣  ◥#\n#  ◢◤  ◢◤◥◣  ◥◣  #\n#  .  ◢◤  ◥◣  .  #\n#    ◢◤    ◥◣    #\n##################\n")),levels.push(new Level(2,30,"\n◢#########◣\n#+ _g##◤__◥◣\n# +_g#◤__._#####◣\n#  +#◤____◢◤.___◥◣\n#  ◢◤_◢#_#◤___#◣_◥◣\n#  #__#____◢#◣_◥◣_#\n#  #__#_.__#_#__#_◥◣\n#  ◥◣_◥◣___◥#◤_◢◤__#\n#  _◥◣_◥##◣___◢◤__◢◤\n#  _+◥◣___#◣.◢◤_:◢◤\n#  +__#_x_###◤…_◢◤\n# +_  ◥###◤____◢◤\n#+ __ _______:◢◤\n◥#############◤\n")),levels.push(new Level(3,30,"\n##########################\n##########################\n##◜        ◥###        ◝##\n##          ◥##         ##\n##      #◣        ###   ##\n##      ◥#◣       ##    ##\n#####    ###########    ##\n#####    ###########   ###\n##       ##       ##   ###\n##       ##       ##    ##\n##   o##### x ##  ##    ##\n##    ##########  ####  ##\n##mmmm##    ###    ###gg##\n##    ##    ####  ########\n##    ##  #####    #######\n##o   ##  ######  ########\n##    ##  ######       ◝##\n##    ##      ##◣       ##\n##    ##      ###### o  ##\n##        ##            ##\n##       ◢##◟          ◞##\n##########################\n##########################\n")),levels.push(new Level(3,30,"\n#####################\n#                   #\n# x          #     ◢#\n##########^^^####  ##\n#g       #^^^      ◥#\n#g       #          #\n#g       #   ########\n#####……  #   <<<<<<<#\n#        #   <<<<<<<#\n#        #   #      #\n#....#####   #      #\n#    >>>>>          #\n#    >>>>>    o    o#\n#    #########      #\n#◣                 ◢#\n##◣               ◢##\n#####################\n")),levels.push(new Level(3,30,"\n#############################\n##◤                 o       #\n#◤     ◢◣     o             #\n#     ◢◤◥◣                  #\n#     ◥◣◢################   #\n#      ◥#◤    . : . : .     #\n# o     #                  ◢#\n#       #     . : . : .   ◢##\n#   o   #     ###############\n#       #   ◢◣  ◢◣  ◢◣   #gg#\n#…     …#   ◥◤  ◥◤  ◥◤   #  #\n#       # ◢◣  ◢◣  ◢◣  ◢◣ #  #\n#  #o#  # ◥◤  ◥◤  ◥◤  ◥◤ #. #\n#  # #  #   ◢◣  ◢◣  ◢◣   #  #\n#  #x#  #   ◥◤  ◥◤  ◥◤   # .#\n#  #m#  # ◢◣  ◢◣  ◢◣  ◢◣    #\n#       # ◥◤  ◥◤  ◥◤  ◥◤    #\n#############################\n")),levels.push(new Level(3,30,"\n##################\n#          ◝#gggg#\n# x         #o   #\n##########  #    #\n#◜      ◝#  #   ◥#\n#        #  #    #\n#  o  o  #  #◤   #\n#  #  #     #    #\n#◟◞#  #◟   ◞#   ◥#\n####  #######    #\n#◜    #◜   ◝#◤   #\n#    ◞#     #    #\n#  ####  #  #   ◥#\n#        #       #\n#◟      ◞#◟     ◞#\n##################\n")),levels.push(new Level(3,30,"\n###################\n#◤___◥#_____#_____#\n#_____#_____#_ggg_#\n#________o__#_ggg_#\n#__  _#_____#_ggg_#\n#◣_x_◢#_____#_____#\n#########_#####_###\n#_____#_____#_____#\n#_o___#_o___#_____#\n#__o________#_____#\n#___o_#___o_#_____#\n#_____#_____#_____#\n###_###########_###\n#_____#_____#_____#\n#_o_o_#_o_o_#_ooo_#\n#________o________#\n#_o_o_#_o_o_#_ooo_#\n#_____#_____#_____#\n###################\n")),levels.push(new Level(3,30,"\n###################\n#___#_____#_______#\n#___#_____#_______#\n#___#_____#_______#\n#_#_#__#__#___#___#\nN_N_N__N__N___N___N\nN_N_N__N__N___N___N\nN_N_N__N__N___N___N\n#_#_#__#__#___#___#\n#_#____#______#___#\n#_#____#______#___#\n#g#____#______#_x_#\n###################\n")),levels.push(new Level(4,30,"\n#######     ############\n#o    #     #          #\n#     #……………#  ◢ ◣     #\n#  #                   #\n#   o #……………#  ◥ ◤     #\n#    o#     #### #######\n### ###        : :\n  : :          : :\n  : :          : +…………+\n  : :          :      :\n  # ######     +…………+ :\n  #   .  #          : :\n  # .  . #………####   : :\n  #             #   : :\n  # . . .#………#  #   ggg\n  #      #   # x#   ggg\n  ########   ####   \n")),levels.push(new Level(4,30,"\n   ###################\n   #◜         ##ggggg#\n   # ####### ###◝   ◜#\n####v##### : : #  o  #\n#◜      ◝#     #◝   ◜#\n# ## ### #     #  .  #\n# ## # # #  x  #◝   ◜#\n#◟  ◞# # #######     #\n########v##    .     #\n    #◜          o    #\n    # ## ##    .    ◞#\n    # ## #############\n    #◟  ◞#\n    ######\n")),levels.push(new Level(4,30,"q\n############################\n#     o     o           <  #\n#                       <  #\n#  ###o#####o############^^#\n#  #          :            #\n#  #          :           ◞#\n#  #  ◢#####◣   ◢###########\n#  #◣       ◥###◤         ◥#\n#  ##◣                     #\n#  # #◣             ◢##◣   #\n#  #  #◣  <<<< .   ◢#  #◣  #\n#gg######################^^#\n#  #        ◥◤        .  ^^#\n#                  . . . ^^#\n# x  ◢◣        #         ^^#\n#############o##############\n")),levels.push(new Level(5,60,"q\n############################\n##########       ###########\n#                .         #\n# x       ◢◣         .     #\n#####^######   ###        ◢#\n#####◟<<<<<<<<<###       ◢##\n##################  ########\n#  . . . . . . . . . . . . #\n# . . . . . . . . . . . .  #\n#  . . . . . . . . . . . . #\n# . . . . . . . . . . . .  #\n#  . . . . . . . . . . . . #\n# . . . . . . . . . . . .  #\n#  . . . . . . . . . . . . #\n#  # # # #^# # # # # # # #^#\n#  #o#v#v#^# # # #o# # # #^#\n#oo###v#v#^#o# #o### #v#v#^#\n######v#v#^##◤ ◥#### #v#v#^#\n######◟>>>◞##gggggggg#◟>>>◞#\n############################\n")),levels.push(new Level(5,30,"q\n##########################\n##########################\n##                   <<◝##\n##                   << ##\n##        ◢#◣        ##^##\n##   ◞◟   ◥#◤   ◞◟   ##^##\n##    .         .    ##^##\n##      ..   ..      ##^##\n##  ◞◟     .     ◞◟  ##^##\n##        ◢#◣        ##^##\n##    .         .    ##^##\n##o .    .   .    . o##^##\n##     .  <^>  .     ##^##\n##   o   <mmm>   o   ##^##\n##◣      #ggg#      ◢##^##\n###◣  .  ◥###◤  .  ◢###^##\n##◤  . .       . .  ◥##^##\n##  . o .     . o .  ##^##\n## . . . . . . . . . ##^##\n##. . . . . . . . . .##^##\n#◜  <<< <<< <<< <<< ◢##^##\n#  x###################^##\n#◟>>>>>>>>>>>>>>>>>>>>>◞##\n##########################\n##########################\n"))}function MainMenu(){view.setRotation(-Math.PI/2),currentLevels=null,currentMenu=[],currentMenu.push(new MenuLabel(30,30,240,60,"New Game"));var e=95,t=["Practice","Easy","Medium","Hard","Special"];loadLevels();for(var n=function(n){var i=levels.filter(function(e){return e.difficulty===n+1}).length,r=t[n]+" ("+i+" stages)",o=new BaseMenuElement(50,e,200,40,r,!1);o.onClick=function(){currentMenu=[],loadLevels(),currentLevels=new LevelSet(levels.filter(function(e){return e.difficulty==n+1}))},currentMenu.push(o),e+=45},i=0;i<t.length;i++)n(i);currentMenu.push(new MenuLabel(30,e,240,120,"")),e+=65;var r=new BaseMenuElement(50,e,200,40,"Level Editor",!1);r.onClick=function(){currentMenu=[],StartEditor()},currentMenu.push(r)}function UITick(){if(mouseHandler.isMouseLeftClicked)for(var e=0,t=currentMenu;e<t.length;e++){var n=t[e];n.isMouseWithin()&&n.onClick()}}function DrawUI(){if(currentMenu.length){var e=5,t=Math.min.apply(null,currentMenu.map(function(e){return e.x}))-e,n=Math.max.apply(null,currentMenu.map(function(e){return e.x+e.width}))+e,i=Math.min.apply(null,currentMenu.map(function(e){return e.y}))-e,r=Math.max.apply(null,currentMenu.map(function(e){return e.y+e.height}))+e;view.ctx.fillStyle="rgba(45,45,63,0.3)",view.ctx.fillRect(t+5,i+5,n-t,r-i),view.ctx.fillStyle="rgba(45,45,63,1)",view.ctx.fillRect(t,i,n-t,r-i);for(var o=0,s=currentMenu;o<s.length;o++){var a=s[o];a.draw(view)}view.drawCenteredText("Spinball",.08,.65),view.drawCenteredText("An unfinished game",.05,.75)}}function onlyUnique(e,t,n){return n.indexOf(e)===t}function GetSubClasses(e,t){var n=Object.keys(window).map(function(e){return window[e]}).filter(function(t){return t&&t.prototype&&t.prototype instanceof e});return t&&(n=n.filter(function(e){return!HasSubClasses(e)})),n}function HasSubClasses(e){return Object.keys(window).map(function(e){return window[e]}).filter(function(t){return t&&t.prototype&&t.prototype instanceof e}).length>0}function RandBetween(e,t){return Math.random()*(t-e)+e}function WeightedAvg(e,t,n){return e*(1-n)+t*n}function GetFuncArgs(e){return(e+"").replace(/[\/][\/].*$/gm,"").replace(/\s+/g,"").replace(/[\/][*][^\/*]*[*][\/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)}function Create(e,t){return new((n=window[e]).bind.apply(n,[void 0].concat(t)));var n}function NumRange(e,t,n){if(void 0===t&&(t=e),void 0===n&&(n=1),e===t&&(e=0),n<=0)throw"Invalid step: "+n;for(var i=[],r=e;r<t;r+=n)i.push(r);return i}function Nums(e,t){return Array.from(new Array(t),function(t,n){return e})}var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},currentLevels;window.onload=function(){var e=document.getElementById("canvas");view=new View(e),document.onkeydown=keyboardState.handleKeyDown,document.onkeyup=keyboardState.handleKeyUp,e.addEventListener("mousedown",mouseHandler.onMouseDown,!1),e.addEventListener("mouseup",mouseHandler.onMouseUp,!1),e.addEventListener("mousemove",mouseHandler.onMouseMove,!1),e.addEventListener("touchstart",mouseHandler.onMouseDown,!1),e.addEventListener("touchmove",mouseHandler.onMouseMove,!1),e.addEventListener("touchend",mouseHandler.onMouseUp,!1),e.oncontextmenu=function(e){e.preventDefault()},window.onresize=function(){view.onResize()},MainMenu(),MainLoop()};var lastUpdate=+new Date,framesPerSecond=60,msPerUpdate=1e3/framesPerSecond,planck,gravityStrength=10,Mode;(function(e){e[e.edit=0]="edit",e[e.test=1]="test",e[e.play=2]="play"})(Mode||(Mode={}));var gameMode=Mode.play,levelString="\n#####\n#___#\n#_x_#\n#####\n",editorButtons=[],editorPaneWidth=350,editorTestCompleteTime=0,Key={None:0,Enter:13,Shift:16,Ctrl:17,Alt:18,Pause:19,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,Digit0:48,Digit1:49,Digit2:50,Digit3:51,Digit4:52,Digit5:53,Digit6:54,Digit7:55,Digit8:56,Digit9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LWindow:91,RWindow:92,ContextMenu:93,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,NumPadMultiply:106,NumPadAdd:107,NumPadEnter:108,NumPadSubtract:109,NumPadDecimal:110,NumPadDivide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NumLock:144,ScrollLock:145,SemiColon:186,Equal:187,Comma:188,Minus:189,Period:190,Slash:191,Backtick:192,LeftBracket:219,BackSlash:220,RightBracket:221,Quote:222},KeyboardHandler=function(){function e(){this.keyState={},this.keyStateOld={},this.handleKeyDown=function(e){e=e||window.event,keyboardState.keyState[e.keyCode]=!0},this.handleKeyUp=function(e){e=e||window.event,keyboardState.keyState[e.keyCode]=!1},this.isKeyChanged=function(e){return this.keyState[e]!==this.keyStateOld[e]}}return e.prototype.isLeftPressed=function(){return this.keyState[Key.Left]||this.keyState[Key.A]},e.prototype.isRightPressed=function(){return this.keyState[Key.Right]||this.keyState[Key.D]},e.prototype.isDownPressed=function(){return this.keyState[Key.Down]||this.keyState[Key.S]},e.prototype.isUpPressed=function(){return this.keyState[Key.Up]||this.keyState[Key.W]},e.prototype.isSpacePressed=function(){return this.keyState[Key.Space]},e.prototype.isAnyPressed=function(){for(var e in this.keyState)if(this.keyState[e])return!0;return!1},e.prototype.cycleKeyState=function(){for(var e in this.keyState)this.keyStateOld[e]=this.keyState[e]},e}(),keyboardState=new KeyboardHandler,Level=function(){function e(e,t,n,i){void 0===i&&(i=""),this.difficulty=e,this.time=t,this.levelString=n,this.tip=i,this.fullRotation=!0,this.pushers=[],this.complete=!1,this.secondsToComplete=0,this.hurtTimer=0}return e.prototype.Step=function(e){return gameMode==Mode.edit?void EditorTick():void(this.world&&(this.world.step(e),this.OnWorldStep(this.world,e)))},e.prototype.OnWorldStep=function(e,t){this.startTime||(this.startTime=+new Date);var n=2,i=60,r=i*n,o=2*Math.PI/r;if(keyboardState.isLeftPressed()&&keyboardState.isRightPressed()||(keyboardState.isRightPressed()?this.RotateGrav(e,o):keyboardState.isLeftPressed()&&this.RotateGrav(e,-o)),keyboardState.isDownPressed()&&gameMode==Mode.test&&StartEditor(),this.ball){var s=this.ball.getPosition(),a=this.ball.getLinearVelocity(),l=20;this.ball.setLinearVelocity(a.clamp(l));for(var _=[],u=0,h=this.pushers;u<h.length;u++){var d=h[u],c=d.userData;if(c.active&&_.indexOf(c.direction)==-1){var f=.2,p=planck.Vec2(f*c.direction.x,f*c.direction.y);this.ball.applyLinearImpulse(p,s,!0),_.push(c.direction)}}}this.hurtTimer&&(this.hurtTimer-=t,this.hurtTimer<0&&(this.hurtTimer=0))},e.prototype.RotateGrav=function(e,t){var n=e.getGravity(),i=Math.atan2(n.y,n.x),r=i+t;this.fullRotation||(r<3*-Math.PI/4&&(r=3*-Math.PI/4),r>1*-Math.PI/4&&(r=1*-Math.PI/4));var o=Math.cos(r)*gravityStrength,s=Math.sin(r)*gravityStrength;e.setGravity(planck.Vec2(o,s)),view.setRotation(r)},e.prototype.OnTouchHurt=function(){this.hurtTimer>0||(this.hurtTimer=1,currentLevels.timer-=1)},e.prototype.loadWorld=function(){loadLevelTiles(),view.setRotation(-Math.PI/2);var e=planck,t=e.Vec2,n=new e.World({gravity:t(0,-gravityStrength)});n.on("pre-solve",function(e){var n=currentLevels.currentLevel,i=e.getFixtureA(),r=i.getBody(),o=e.getFixtureB(),s=o.getBody(),a=i.getUserData()==fds.ball.userData&&r||o.getUserData()==fds.ball.userData&&s,l=i.getUserData()==fds.breakWall.userData&&r||o.getUserData()==fds.breakWall.userData&&s;if(a&&l){var _=a.getLinearVelocity(),u=a.getPosition(),h=l.getPosition(),d={x:h.x-u.x,y:h.y-u.y},c=a.getLinearVelocity().length(),f=Math.atan2(_.y,_.x)-Math.atan2(d.y,d.x),p=c*Math.cos(f);p>4&&setTimeout(function(){try{var e=l.getUserData();currentLevels.timer+=e,currentLevels.currentLevel.ball.setLinearVelocity(t(0,0)),n.world.destroyBody(l)}catch(e){}},1)}}),n.on("post-solve",function(e){var n=currentLevels.currentLevel,i=e.getFixtureA(),r=i.getBody(),o=e.getFixtureB(),s=o.getBody(),a=i.getUserData()==fds.bouncer.userData&&r||o.getUserData()==fds.bouncer.userData&&s,l=i.getUserData()==fds.ball.userData&&r||o.getUserData()==fds.ball.userData&&s,_=i.getUserData()==fds.goal.userData&&r||o.getUserData()==fds.goal.userData&&s,u=i.getUserData()==fds.timerPenalty.userData&&r||o.getUserData()==fds.timerPenalty.userData&&s;if(a&&l){var h=l.getPosition(),d=a.getPosition(),c=Math.atan2(h.y-d.y,h.x-d.x),f=10,p=t(f*Math.cos(c),f*Math.sin(c));l.applyLinearImpulse(p,h,!0)}if(l&&u&&n&&n.OnTouchHurt(),l&&_&&n){var v=+new Date-n.startTime;n.complete=!0,n.secondsToComplete=Math.floor(v)/1e3}}),n.on("begin-contact",function(e){var t=e.getFixtureA(),n=t.getBody(),i=e.getFixtureB(),r=i.getBody(),o=t.getUserData()==fds.ball.userData&&n||i.getUserData()==fds.ball.userData&&r,s=t.getUserData()==fds.pusher.userData&&n||i.getUserData()==fds.pusher.userData&&r;o&&s&&(s.userData.active=!0)}),n.on("end-contact",function(e){var t=e.getFixtureA(),n=t.getBody(),i=e.getFixtureB(),r=i.getBody(),o=t.getUserData()==fds.ball.userData&&n||i.getUserData()==fds.ball.userData&&r,s=t.getUserData()==fds.pusher.userData&&n||i.getUserData()==fds.pusher.userData&&r;o&&s&&(s.userData.active=!1)}),this.world=n;for(var i=0;i<this.levelString.split("\n").length;i++)for(var r=this.levelString.split("\n")[i],o=(this.levelString.split("\n")[i+1],0);o<r.length;o++){var s=2*o,a=2*-i,l=r[o],_=levelTiles.find(function(e){return e.character==l});_&&_.addToLevel(this,s,a)}},e.prototype.AddPin=function(e,t){var n=this.world.createBody(planck.Vec2(e,t));n.createFixture(planck.Circle(.25),fds.pin)},e.prototype.AddTriangle=function(e,t,n){var i=this.world.createBody(planck.Vec2(e,t),n),r=[planck.Vec2(1,-1),planck.Vec2(-1,1),planck.Vec2(-1,-1)];i.createFixture(planck.Polygon(r),fds.wall)},e.prototype.AddPusher=function(e,t,n){var i=this.world.createBody(planck.Vec2(e,t));i.userData={direction:n,active:!1},i.createFixture(fds.pusher),this.pushers.push(i)},e.prototype.AddCurve=function(e,t,n){for(var i=this.world.createBody(planck.Vec2(e,t),n),r=[],o=10,s=0;s<=o;s++){var a=s/o*Math.PI/2+Math.PI,l=2*Math.cos(a)+1,_=2*Math.sin(a)+1;r.push(planck.Vec2(l,_))}for(var s=0;s<o;s++){var u=[planck.Vec2(-1,-1),planck.Vec2(r[s].x,r[s].y),planck.Vec2(r[s+1].x,r[s+1].y)];i.createFixture(planck.Polygon(u),fds.curve)}},e.prototype.AddBreakWall=function(e,t,n){var i=this.world.createBody(planck.Vec2(e,t));i.createFixture(planck.Box(.5,.5),fds.breakWall),i.setUserData(n)},e}(),fds={ball:null,wall:null,curve:null,bouncer:null,pin:null,goal:null,pusher:null,breakWall:null,rotationLock:null,timerPenalty:null},Direction=function(){function e(e,t){this.x=e,this.y=t,this.innerArrow=[],this.innerArrow.push({x:.5*e,y:.5*t}),e||this.innerArrow.push({x:.5*t,y:0},{x:.5*-t,y:0}),t||this.innerArrow.push({x:0,y:.5*e},{x:0,y:.5*-e})}return e.Left=new e(-1,0),e.Right=new e(1,0),e.Up=new e(0,1),e.Down=new e(0,-1),e}(),LevelTile=function(){function e(e,t,n,i){void 0===i&&(i=""),this.character=e,this.name=t,this.addToLevel=n,this.group=i}return e}(),levelTiles=[],levels=[],LevelSet=function(){function e(e){this.levels=e,this.timeOut=!1,this.levelCompleteTimer=0,this.canContinueToNext=!1,this.showTimerExtend=!1,this.levelStartTime=3,this.currentLevel=e[0],this.currentLevel.loadWorld(),this.timer=this.currentLevel.time}return Object.defineProperty(e.prototype,"readableLevelNumber",{get:function(){return this.levelIndex+1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"levelIndex",{get:function(){return this.levels.indexOf(this.currentLevel)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"prettyTimeRemaining",{get:function(){return(Math.floor(100*this.timer)/100).toFixed(2)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"prettyTimeElapsed",{get:function(){if(!this.currentLevel)return"";var e=(+new Date-this.currentLevel.startTime)/1e3;return(Math.floor(100*e)/100).toFixed(2)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nextLevel",{get:function(){var e=this.levelIndex+1;return this.levels[e]},enumerable:!0,configurable:!0}),e.prototype.Step=function(e){if(this.levelCompleteTimer>4&&(this.canContinueToNext=!0),this.currentLevel){if(this.canContinueToNext&&keyboardState.isAnyPressed()){if(this.timeOut)return this.currentLevel=null,void MainMenu();this.StartNextLevel()}if(this.timeOut)return void(this.levelCompleteTimer+=e);if(this.currentLevel&&this.currentLevel.complete){if(gameMode==Mode.test)return editorTestCompleteTime=(+new Date-this.currentLevel.startTime)/1e3,void StartEditor();this.levelCompleteTimer+=e,this.levelCompleteTimer>2&&!this.showTimerExtend&&this.nextLevel&&(this.timer+=this.nextLevel.time,this.timer>99.99&&(this.timer=99.99),this.showTimerExtend=!0)}else gameMode==Mode.play&&this.levelStartTime>0||(this.timer-=e,this.timer<=0&&gameMode==Mode.play?(this.timer=0,this.timeOut=!0):this.currentLevel&&this.currentLevel.Step(e));this.levelStartTime-=e}},e.prototype.StartNextLevel=function(){this.levelCompleteTimer=0,this.canContinueToNext=!1,this.currentLevel=this.nextLevel,this.currentLevel?(this.currentLevel.loadWorld(),this.levelStartTime=3,this.showTimerExtend=!1):MainMenu()},e.prototype.Draw=function(e){var t=this.currentLevel;if(t&&(e.draw(t),gameMode==Mode.test&&(e.drawCenteredText(this.prettyTimeElapsed,.05,.05),e.drawCenteredText("S/Down to resume editing",.04,.95)),gameMode==Mode.edit&&editorTestCompleteTime&&e.drawCenteredText("Last test play completed in: "+editorTestCompleteTime.toFixed(2),.03,.95),gameMode==Mode.play))if(e.drawCenteredText(this.prettyTimeRemaining,.05,.05),this.timeOut)e.drawCenteredText("Times up!",.15,.2),this.canContinueToNext&&e.drawCenteredText("Hit any key to continue",.06,.8);else if(t.complete){if(e.drawCenteredText("Level Complete!",.1,.35),e.drawCenteredText(t.secondsToComplete.toFixed(2)+" seconds",.08,.55),this.levelCompleteTimer>2)if(this.nextLevel){var n=this.nextLevel.time;n&&e.drawCenteredText("+"+n+" seconds to timer",.06,.65)}else e.drawCenteredText("Campaign Complete!",.08,.65);this.canContinueToNext&&e.drawCenteredText("Hit any key to continue",.06,.8)}else this.levelStartTime>1.5?e.drawCenteredText("Get ready...",.1,.2):this.levelStartTime>0?e.drawCenteredText("Get set...",.15,.2):this.levelStartTime>-.5&&e.drawCenteredText("Go!",.2,.2)},e}(),MouseHandler=function(){function e(){this.mouseX=0,this.mouseY=0,this.oldMouseX=0,this.oldMouseY=0,this.isMouseLeftClicked=!1,this.oldIsMouseLeftClicked=!1,this.isMouseLeftChanged=!1,this.isMouseRightClicked=!1,this.oldIsMouseRightClicked=!1,this.isMouseRightChanged=!1,this.mouseDeltaX=0,this.mouseDeltaY=0,this.m_isMouseLeftClicked=!1,this.m_isMouseRightClicked=!1,this.m_mouseX=0,this.m_mouseY=0}return e.prototype.onMouseDown=function(e){void 0===e.button||0===e.button?(mouseHandler.m_isMouseLeftClicked=!0,
mouseHandler.m_mouseX=e.pageX,mouseHandler.m_mouseY=e.pageY):2==e.button&&(mouseHandler.m_isMouseRightClicked=!0,mouseHandler.m_mouseX=e.pageX,mouseHandler.m_mouseY=e.pageY)},e.prototype.onMouseUp=function(e){void 0===e.button||0===e.button?mouseHandler.m_isMouseLeftClicked=!1:2==e.button&&(mouseHandler.m_isMouseRightClicked=!1)},e.prototype.onMouseMove=function(e){var t=e.pageX,n=e.pageY,i=t,r=n;mouseHandler.mouseDeltaX=i-mouseHandler.m_mouseX,mouseHandler.mouseDeltaY=r-mouseHandler.m_mouseY,mouseHandler.m_mouseX=i,mouseHandler.m_mouseY=r},e.prototype.UpdateMouseDelta=function(){mouseHandler.mouseX=mouseHandler.m_mouseX,mouseHandler.mouseY=mouseHandler.m_mouseY,mouseHandler.isMouseLeftClicked=mouseHandler.m_isMouseLeftClicked,mouseHandler.isMouseRightClicked=mouseHandler.m_isMouseRightClicked,mouseHandler.mouseDeltaX=mouseHandler.mouseX-mouseHandler.oldMouseX,mouseHandler.mouseDeltaY=mouseHandler.mouseY-mouseHandler.oldMouseY,mouseHandler.oldMouseX=mouseHandler.mouseX,mouseHandler.oldMouseY=mouseHandler.mouseY,mouseHandler.isMouseLeftChanged=mouseHandler.oldIsMouseLeftClicked!=mouseHandler.isMouseLeftClicked,mouseHandler.oldIsMouseLeftClicked=mouseHandler.isMouseLeftClicked,mouseHandler.isMouseRightChanged=mouseHandler.oldIsMouseRightClicked!=mouseHandler.isMouseRightClicked,mouseHandler.oldIsMouseRightClicked=mouseHandler.isMouseRightClicked},e}(),mouseHandler=new MouseHandler,Tileset=function(){function e(e){this.loaded=!1,this.load(e)}return e.prototype.load=function(e){var t=this;this.image=document.getElementById(e),this.image&&this.image.width?this.init():setTimeout(function(){t.load(e)})},e.prototype.init=function(){this.loaded=!0},e.prototype.drawTile=function(e){if(this.loaded){var t=this.image.width/3*e,n=0,i=this.image.width/3,r=this.image.height;view.ctx.drawImage(this.image,t,n,i,r,-view.scale,-view.scale,2*view.scale,2*view.scale)}},e.prototype.drawSolid=function(){this.drawTile(0)},e.prototype.drawTriangle=function(){this.drawTile(1)},e.prototype.drawCurve=function(){this.drawTile(2)},e}(),testTileset=new Tileset("testImage"),BaseMenuElement=function(){function e(e,t,n,i,r,o){void 0===o&&(o=!0),this.x=e,this.y=t,this.width=n,this.height=i,this.text=r,this.contentCentered=o,this.labelOnly=!1}return e.prototype.isMouseWithin=function(){return!(mouseHandler.mouseX<this.x)&&(!(mouseHandler.mouseX>this.x+this.width)&&(!(mouseHandler.mouseY<this.y)&&!(mouseHandler.mouseY>this.y+this.height)))},e.prototype.draw=function(e){this.labelOnly||(e.ctx.fillStyle="rgba(70,70,85,0.55)",this.isMouseWithin()&&(e.ctx.fillStyle="rgba(75,75,100,0.85)",this instanceof EditorButtonElement&&this.isActive&&(e.ctx.fillStyle="rgba(85,85,100,0.85)")),e.ctx.fillRect(this.x,this.y,this.width,this.height),this instanceof EditorButtonElement&&this.isActive&&(e.ctx.lineWidth=3,e.ctx.strokeStyle="rgba(75,75,100,1)",e.ctx.strokeRect(this.x,this.y,this.width,this.height))),e.ctx.font=this.height/2+"px Arial";var t=this.width-10;e.ctx.fillStyle="rgba(45,45,63,1)";var n=this.x+5,i=this.y+.75*this.height;if(this.contentCentered){var r=Math.min(t,e.ctx.measureText(this.text).width),o=t-r;n+=o/2}e.ctx.fillText(this.text,n+2,i+2,t),e.ctx.fillStyle="rgba(110,110,145,1)",e.ctx.fillText(this.text,n,i,t)},e.prototype.onClick=function(){},e}(),MenuLabel=function(e){function t(t,n,i,r,o){e.call(this,t,n,i,r,o),this.x=t,this.y=n,this.width=i,this.height=r,this.text=o,this.labelOnly=!0}return __extends(t,e),t}(BaseMenuElement),EditorButtonElement=function(e){function t(t,n,i,r,o,s,a){e.call(this,t,n,i,r,s),this.x=t,this.y=n,this.width=i,this.height=r,this.index=o,this.text=s,this.isActive=a}return __extends(t,e),t.prototype.onClick=function(){for(var e=0,n=editorButtons;e<n.length;e++){var i=n[e];i instanceof t&&(i.isActive=!1)}this.isActive=!0},t}(BaseMenuElement),EditorButton=function(e){function t(t,n,i,r,o,s){e.call(this,t,n,i,r,o),this.x=t,this.y=n,this.width=i,this.height=r,this.text=o,this.action=s}return __extends(t,e),t.prototype.onClick=function(){mouseHandler.isMouseLeftChanged&&(mouseHandler.isMouseLeftChanged=!1,mouseHandler.isMouseLeftClicked=!1,mouseHandler.m_isMouseLeftClicked=!1,this.action())},t}(BaseMenuElement),currentMenu=[];Array.prototype.distinct||(Array.prototype.distinct=function(){return this.filter(onlyUnique)}),Array.prototype.popRand||(Array.prototype.popRand=function(){var e=Math.floor(Math.random()*this.length);return this.splice(e,1)}),Array.prototype.rand||(Array.prototype.rand=function(){return this.length?this[Math.floor(Math.random()*this.length)]:null}),Array.prototype.sum||(Array.prototype.sum=function(){return this.reduce(function(e,t){return e+t},0)}),Array.prototype.max||(Array.prototype.max=function(){if(0==this.length)return null;for(var e=this[0],t=0,n=this;t<n.length;t++){var i=n[t];i>e&&(e=i)}return e}),Array.prototype.min||(Array.prototype.min=function(){if(0==this.length)return null;for(var e=this[0],t=0,n=this;t<n.length;t++){var i=n[t];i<e&&(e=i)}return e}),Array.prototype.find||(Array.prototype.find=function(e){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),i=n.length>>>0,r=arguments[1],o=0;o<i;o++)if(t=n[o],e.call(r,t,o,n))return t});var View=function(){function e(e){this.canvas=e,this.x=0,this.y=0,this.targetX=0,this.targetY=0,this.offsetX=0,this.offsetY=0,this.targetScale=50,this.scale=50,this.rotation=-Math.PI/2,this.ctx=e.getContext("2d"),this.ctx.imageSmoothingEnabled=!1,this.onResize()}return Object.defineProperty(e.prototype,"width",{get:function(){return this.canvas.width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.canvas.height},enumerable:!0,configurable:!0}),e.prototype.setTranslation=function(e,t){this.targetX=e,this.targetY=t},e.prototype.setRotation=function(e){this.ctx.rotate(e-this.rotation),this.rotation=e},e.prototype.onResize=function(){this.ctx.rotate(-this.rotation),this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.ctx.rotate(Math.PI/2),this.ctx.rotate(this.rotation),editorButtons=[]},e.prototype.tickCamera=function(){if(currentLevels&&currentLevels.currentLevel&&currentLevels.currentLevel.ball){var e=currentLevels.currentLevel.ball.getPosition();gameMode==Mode.edit?this.setTranslation(e.x-editorPaneWidth/2/this.scale,e.y):this.setTranslation(e.x,e.y)}gameMode==Mode.edit&&(this.targetScale=15),gameMode!=Mode.test&&gameMode!=Mode.play||(this.targetScale=Math.max(this.canvas.width/40,this.canvas.height/20));var t=this.targetScale-this.scale;this.scale+=.04*t,Math.abs(t)<.1&&(this.scale=this.targetScale),gameMode!==Mode.edit&&(this.offsetX=0,this.offsetY=0),this.x+=.1*(this.targetX+this.offsetX-this.x),this.y+=.1*(this.targetY+this.offsetY-this.y)},e.prototype.getMapCoordsFromScreenCoords=function(e,t){var n=(e-this.width/2)/this.scale+this.x,i=(t-this.height/2)/-this.scale+this.y;return{x:n,y:i}},e.prototype.getBottomLeftGameCoordOfMouseOverCell=function(){var e=this.getMapCoordsFromScreenCoords(mouseHandler.mouseX,mouseHandler.mouseY),t=e.x+1,n=e.y+1;return t=2*Math.floor(t/2),n=2*Math.floor(n/2),{x:t,y:n}},e.prototype.mapX=function(e){return(e-this.x)*this.scale+Math.cos(this.rotation)*this.height/2-Math.sin(this.rotation)*this.width/2},e.prototype.mapY=function(e){return-(e-this.y)*this.scale-Math.sin(this.rotation)*this.height/2-Math.cos(this.rotation)*this.width/2},e.prototype.clear=function(){this.ctx.clearRect(-this.width-this.height,-this.width-this.height,2*(this.width+this.height),2*(this.width+this.height))},e.prototype.draw=function(e){this.tickCamera();for(var t=e.world,n=t.getBodyList();n;n=n.getNext()){var i=n.getPosition();this.ctx.translate(this.mapX(i.x),this.mapY(i.y));for(var r=n.getAngle(),o=n.getFixtureList();o;o=o.getNext()){var s=o.getType(),a=o.getShape(),l=o.getUserData();if("circle"==s){this.ctx.fillStyle="rgba(0,0,200,0.6)","bouncer"==l&&(this.ctx.fillStyle="rgba(200,0,200,0.6)"),"ball"==l&&(this.ctx.fillStyle="rgba(0,0,0,0.6)",e.hurtTimer>0&&(this.ctx.fillStyle="rgba(60,0,0,0.6)"));var r=a.m_radius;this.ctx.beginPath(),this.ctx.arc(0,0,r*this.scale,0,2*Math.PI),this.fill(),this.stroke()}else if("goal"==l)this.ctx.fillStyle="rgba(0,200,0,0.6)",this.createPath(a.m_vertices),this.fill();else if("timerPenalty"==l)this.ctx.fillStyle="rgba(200,0,0,0.6)",this.createPath(a.m_vertices),this.fill(),this.stroke();else if("rotationLock"==l&&gameMode==Mode.edit)this.ctx.fillStyle="rgba(255,255,255,0.6)",this.createPath(a.m_vertices),this.fill();else if("pusher"==l)this.ctx.fillStyle="rgba(200,0,128,0.6)",this.createPath(a.m_vertices),this.fill(),this.ctx.fillStyle="rgba(0,0,200,0.6)",this.createPath(n.userData.direction.innerArrow),this.fill();else if("breakWall"==l){this.ctx.fillStyle="rgba(196,92,0,0.6)",this.createPath(a.m_vertices),this.fill(),this.stroke();var _=n.getUserData();if(_){var u=(_>0?"+":"")+_;this.ctx.font=.75*this.scale+"px Arial";var h=this.ctx.measureText(u).width;this.ctx.fillStyle=_>0?"green":"red",this.ctx.fillText(u,-h/2+x0,this.scale/4)}}else this.ctx.rotate(-r),this.createPath(a.m_vertices),this.ctx.fillStyle="rgba(0,0,200,0.6)",this.fill(),this.stroke(),this.ctx.rotate(r)}this.ctx.translate(-this.mapX(i.x),-this.mapY(i.y))}var d=this.getBottomLeftGameCoordOfMouseOverCell();gameMode==Mode.edit&&(this.highlightCell(d.x,d.y),DrawEditorPane(this)),e.tip.length&&currentLevels.levelStartTime<=0&&!e.complete&&this.drawCenteredText(e.tip,.05,.95)},e.prototype.highlightCell=function(e,t){var n=[{x:e-1,y:t-1},{x:e+1,y:t-1},{x:e+1,y:t+1},{x:e-1,y:t+1}];this.ctx.fillStyle="rgba(255,255,255,0.6)",this.ctx.translate(this.mapX(0),this.mapY(0)),this.ctx.beginPath(),this.createPath(n),this.fill(),this.stroke(),this.ctx.translate(-this.mapX(0),-this.mapY(0))},e.prototype.createPath=function(e){this.ctx.beginPath();var t=e[e.length-1];this.ctx.moveTo(t.x*this.scale,-t.y*this.scale);for(var n=0,i=e;n<i.length;n++){var r=i[n];this.ctx.lineTo(r.x*this.scale,-r.y*this.scale)}},e.prototype.fill=function(){this.ctx.lineWidth=1,this.ctx.fill()},e.prototype.stroke=function(){this.ctx.lineWidth=2,this.ctx.strokeStyle=this.ctx.fillStyle.toString().replace("0.6","1.0"),this.ctx.stroke()},e.prototype.drawCenteredText=function(e,t,n){var i=this.height*t;this.ctx.font=i+"px Arial";var r=this.ctx.measureText(e).width,o=this.width-(Mode.edit==gameMode?editorPaneWidth:0),s=Mode.edit==gameMode?editorPaneWidth:0;if(r>o){var a=t*o/r-.01;if(a<0)return;return void this.drawCenteredText(e,a,n)}var l=o/2-r/2+s,_=(this.height-i)*n+i;this.ctx.rotate(-this.rotation-Math.PI/2),this.ctx.fillStyle="black",this.ctx.fillText(e,l+2,_+2),this.ctx.fillStyle="white",this.ctx.fillText(e,l,_),this.ctx.rotate(this.rotation+Math.PI/2)},e}(),x0=0,y0=0,view=null;